<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>AI Posture Clinic - ë‚¨ì–‘ì£¼ë„ì‹œê³µì‚¬</title>
    
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- Phosphor Icons -->
    <script src="https://unpkg.com/@phosphor-icons/web"></script>

    <!-- MediaPipe Pose -->
    <script src="https://cdn.jsdelivr.net/npm/@mediapipe/pose/pose.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@mediapipe/drawing_utils/drawing_utils.js"></script>

    <style>
        @import url('https://fonts.googleapis.com/css2?family=Noto+Sans+KR:wght@300;400;500;700&display=swap');
        body { font-family: 'Noto Sans KR', sans-serif; background-color: #f8fafc; touch-action: manipulation; }
        
        .hidden { display: none !important; }
        
        /* ì• ë‹ˆë©”ì´ì…˜ */
        .fade-in { animation: fadeIn 0.5s ease-out; }
        .pop-in { animation: popIn 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275); }
        
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
        @keyframes popIn { from { opacity: 0; transform: scale(0.9); } to { opacity: 1; transform: scale(1); } }
        
        .modal-backdrop {
            background-color: rgba(0, 0, 0, 0.75);
            backdrop-filter: blur(4px);
            z-index: 100;
        }
        
        /* ìŠ¤í”¼ë„ˆ */
        .spinner {
            border: 4px solid rgba(255, 255, 255, 0.3);
            border-radius: 50%;
            border-top: 4px solid #0d9488;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
        }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }

        /* ìœ íŠœë¸Œ ë°˜ì‘í˜• ì»¨í…Œì´ë„ˆ */
        .video-container {
            position: relative;
            padding-bottom: 56.25%; /* 16:9 ë¹„ìœ¨ */
            height: 0;
            overflow: hidden;
            border-radius: 0.75rem;
            background: #000;
        }
        .video-container iframe {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
        }
        
        .cursor-pointer { cursor: pointer; }
    </style>
</head>
<body>

    <!-- í—¤ë” -->
    <header class="bg-white shadow-sm sticky top-0 z-10">
        <div class="max-w-3xl mx-auto px-4 py-4 flex items-center justify-between">
            <div class="flex items-center space-x-2">
                <div class="bg-teal-600 p-2 rounded-lg text-white"><i class="ph ph-camera text-xl"></i></div>
                <h1 class="text-xl font-bold tracking-tight text-slate-900">AI Posture Clinic</h1>
            </div>
            <span class="text-xs font-bold bg-teal-50 text-teal-700 px-3 py-1 rounded-full border border-teal-100">Pro 3.12</span>
        </div>
    </header>

    <main class="max-w-3xl mx-auto px-4 mt-8 pb-24">
        
        <!-- 1. ì—…ë¡œë“œ í™”ë©´ (ê¸°ë³¸ í‘œì‹œ) -->
        <div id="upload-view" class="space-y-8 fade-in">
            <div class="text-center space-y-3">
                <h2 class="text-3xl font-extrabold text-slate-900">AI ì •ë°€ ì²´í˜• ë¶„ì„ <span class="text-teal-600"><br/>ìš´ë™ í”„ë¡œê·¸ë¨ ì†”ë£¨ì…˜</span></h2>
                <p class="text-slate-500 max-w-md mx-auto leading-relaxed">ê°ë„ ê¸°ë°˜ ì •ë°€ ì•Œê³ ë¦¬ì¦˜ìœ¼ë¡œ<br/>ê±°ë¶ëª©ê³¼ ì–´ê¹¨ ë¶ˆê· í˜•ì„ ì§„ë‹¨í•©ë‹ˆë‹¤.</p>
                <p class="text-xs text-slate-400">ğŸ“¢ ì—…ë¡œë“œëœ ì‚¬ì§„ì€ ë¶„ì„ í›„ ì¦‰ì‹œ ì‚­ì œë˜ë©° ì €ì¥ë˜ì§€ ì•ŠìŠµë‹ˆë‹¤.</p>
            </div>

            <div class="grid grid-cols-1 md:grid-cols-2 gap-8 justify-items-center">
                
                <!-- ì •ë©´ ì‚¬ì§„ ì—…ë¡œë“œ ë°•ìŠ¤ -->
                <div class="flex flex-col gap-2 w-[200px]">
                    <div id="front-box" class="relative border-2 border-dashed border-slate-300 rounded-2xl p-6 w-[200px] h-[600px] flex flex-col items-center justify-center transition-all duration-300 overflow-hidden bg-white hover:border-teal-400">
                        <!-- ì´ë¯¸ì§€ ë¯¸ë¦¬ë³´ê¸° (ë™ì ìœ¼ë¡œ ì¶”ê°€ë¨) -->
                        <img id="front-preview" class="absolute inset-0 w-full h-full object-contain hidden z-10 bg-black" />
                        
                        <!-- ì´ˆê¸° ì•ˆë‚´ í™”ë©´ -->
                        <div id="front-placeholder" class="flex flex-col items-center w-full h-full relative z-0">
                            <!-- front.jpgê°€ ì—†ìœ¼ë©´ ìˆ¨ê¹€ -->
                            <img src="front.jpg" class="absolute inset-0 w-full h-full object-cover opacity-30 pointer-events-none" onerror="this.style.display='none'">
                            <div class="z-10 flex flex-col items-center justify-center h-full gap-4 w-full">
                                <div class="text-center bg-white/80 p-3 rounded-xl backdrop-blur-sm shadow-sm w-full">
                                    <span class="font-bold text-slate-700 block">ì •ë©´ ì‚¬ì§„</span>
                                    <span class="text-xs text-slate-500">ì–´ê¹¨ ë¼ì¸ì´ ë³´ì´ê²Œ<br/>ì°¨ë · ìì„¸</span>
                                </div>
                                <div class="flex flex-col gap-2 w-full px-4">
                                    <label class="cursor-pointer bg-teal-600 text-white py-3 rounded-xl text-sm font-bold shadow-md hover:bg-teal-700 transition-colors text-center flex items-center justify-center gap-2">
                                        <i class="ph ph-upload-simple text-lg"></i> ì‚¬ì§„ ì—…ë¡œë“œ
                                        <input type="file" id="front-input" accept="image/*" class="hidden">
                                    </label>
                                </div>
                            </div>
                        </div>
                        
                        <!-- ì‚­ì œ ë²„íŠ¼ -->
                        <button id="front-reset-btn" class="hidden absolute top-2 right-2 bg-black/50 text-white p-2 rounded-full hover:bg-black/70 transition-colors z-20">
                            <i class="ph ph-arrows-clockwise text-lg"></i>
                        </button>
                    </div>
                </div>

                <!-- ì¸¡ë©´ ì‚¬ì§„ ì—…ë¡œë“œ ë°•ìŠ¤ -->
                <div class="flex flex-col gap-2 w-[200px]">
                    <div id="side-box" class="relative border-2 border-dashed border-slate-300 rounded-2xl p-6 w-[200px] h-[600px] flex flex-col items-center justify-center transition-all duration-300 overflow-hidden bg-white hover:border-teal-400">
                        <img id="side-preview" class="absolute inset-0 w-full h-full object-contain hidden z-10 bg-black" />
                        
                        <div id="side-placeholder" class="flex flex-col items-center w-full h-full relative z-0">
                            <img src="side.jpg" class="absolute inset-0 w-full h-full object-cover opacity-30 pointer-events-none" onerror="this.style.display='none'">
                            <div class="z-10 flex flex-col items-center justify-center h-full gap-4 w-full">
                                <div class="text-center bg-white/80 p-3 rounded-xl backdrop-blur-sm shadow-sm w-full">
                                    <span class="font-bold text-slate-700 block">ì¸¡ë©´ ì‚¬ì§„</span>
                                    <span class="text-xs text-slate-500">ê·€ì™€ ì–´ê¹¨ê°€<br/>ì˜ ë³´ì´ë„ë¡ ì´¬ì˜</span>
                                </div>
                                <div class="flex flex-col gap-2 w-full px-4">
                                    <label class="cursor-pointer bg-teal-600 text-white py-3 rounded-xl text-sm font-bold shadow-md hover:bg-teal-700 transition-colors text-center flex items-center justify-center gap-2">
                                        <i class="ph ph-upload-simple text-lg"></i> ì‚¬ì§„ ì—…ë¡œë“œ
                                        <input type="file" id="side-input" accept="image/*" class="hidden">
                                    </label>
                                </div>
                            </div>
                        </div>

                        <button id="side-reset-btn" class="hidden absolute top-2 right-2 bg-black/50 text-white p-2 rounded-full hover:bg-black/70 transition-colors z-20">
                            <i class="ph ph-arrows-clockwise text-lg"></i>
                        </button>
                    </div>
                </div>
            </div>

            <div class="flex justify-center pt-2">
                <button id="analyze-btn" class="w-full md:w-auto px-10 py-4 rounded-xl font-bold text-lg shadow-xl shadow-teal-100 transition-all transform active:scale-95 bg-slate-200 text-slate-400 cursor-not-allowed" disabled>
                    AI ì—”ì§„ ë¡œë”© ì¤‘...
                </button>
            </div>
            
            <div class="bg-white p-4 rounded-xl border border-slate-100 shadow-sm">
                <div class="flex items-start gap-3">
                    <i class="ph ph-info text-teal-600 text-xl mt-0.5"></i>
                    <div class="text-xs text-slate-500 leading-relaxed">
                        <strong class="text-slate-700 block mb-1">ì •í™•í•œ ë¶„ì„ì„ ìœ„í•œ íŒ</strong>
                        ì¹´ë©”ë¼ë¥¼ ëˆˆë†’ì´ì— ë‘ê³  ìˆ˜í‰ì„ ë§ì¶° ì°ìœ¼ë©´ ê°€ì¥ ì •í™•í•©ë‹ˆë‹¤. ëª¸ì— ë”± ë¶™ëŠ” ì˜·ì„ ì…ìœ¼ì‹œë©´ ë” ì¢‹ìŠµë‹ˆë‹¤.
                    </div>
                </div>
            </div>
        </div>

        <!-- 2. ë¶„ì„ ê²°ê³¼ í™”ë©´ (ìˆ¨ê¹€) -->
        <div id="result-view" class="space-y-8 hidden fade-in">
            <div class="text-center space-y-2">
                <h2 class="text-2xl font-bold text-slate-900">ë¶„ì„ ì™„ë£Œ</h2>
                <p class="text-slate-500 text-sm">ê°ë„ ë¶„ì„ì„ í†µí•´ ì§„ë‹¨ëœ ê²°ê³¼ì…ë‹ˆë‹¤.</p>
                <p class="text-xs text-teal-600 font-bold bg-teal-50 inline-block px-3 py-1 rounded-full">ğŸ‘‡ ì•„ë˜ ìš´ë™ ì¹´ë“œë¥¼ ëˆ„ë¥´ë©´ ìƒì„¸ ê°€ì´ë“œ ì˜ìƒì´ ì¬ìƒë©ë‹ˆë‹¤.</p>
            </div>

            <!-- ìº”ë²„ìŠ¤ (ê²°ê³¼ ì‹œê°í™”) -->
            <div class="grid grid-cols-2 gap-4 mb-8">
                <div class="relative">
                    <span class="absolute top-2 left-2 bg-black/60 text-white text-[10px] px-2 py-1 rounded backdrop-blur-md">ì •ë©´ (ì–´ê¹¨ ê· í˜•)</span>
                    <canvas id="front-canvas" class="w-full h-auto rounded-lg border border-slate-200 bg-black"></canvas>
                </div>
                <div class="relative">
                    <span class="absolute top-2 left-2 bg-black/60 text-white text-[10px] px-2 py-1 rounded backdrop-blur-md">ì¸¡ë©´ (ëª© ê°ë„)</span>
                    <canvas id="side-canvas" class="w-full h-auto rounded-lg border border-slate-200 bg-black"></canvas>
                </div>
            </div>

            <div id="result-cards" class="grid gap-6">
                <!-- ê²°ê³¼ ì¹´ë“œê°€ JSë¡œ ì—¬ê¸°ì— ì‚½ì…ë©ë‹ˆë‹¤ -->
            </div>

            <button id="reset-all-btn" class="w-full bg-slate-800 text-white py-4 rounded-xl font-bold hover:bg-slate-900 transition-colors shadow-lg flex items-center justify-center gap-2 mt-8">
                <i class="ph ph-arrows-clockwise text-xl"></i> ë‹¤ë¥¸ ì‚¬ì§„ìœ¼ë¡œ ë‹¤ì‹œ ë¶„ì„í•˜ê¸°
            </button>
        </div>

    </main>

    <footer class="mt-12 text-center text-slate-400 text-sm pb-8">
        &copy; 2026 ë‚¨ì–‘ì£¼ë„ì‹œê³µì‚¬ ì „ëµê¸°íšë¶€ AI Posture Clinic.
    </footer>

    <!-- ì„¤ë¬¸ì¡°ì‚¬ í”Œë¡œíŒ… ë²„íŠ¼ -->
    <button onclick="goToSurvey()" class="fixed bottom-6 right-6 bg-slate-900 hover:bg-teal-600 text-white p-4 rounded-full shadow-2xl transition-all z-40 flex items-center gap-2 group">
        <i class="ph ph-clipboard-text text-xl"></i>
        <span class="max-w-0 overflow-hidden group-hover:max-w-xs transition-all duration-300 whitespace-nowrap text-sm font-bold">ì„¤ë¬¸ì¡°ì‚¬ ì°¸ì—¬</span>
    </button>

    <!-- ì´íƒˆ ê°ì§€ ëª¨ë‹¬ -->
    <div id="exit-modal" class="fixed inset-0 z-50 modal-backdrop flex items-center justify-center p-4 hidden pop-in">
        <div class="bg-white rounded-2xl p-8 max-w-sm w-full shadow-2xl relative">
            <button onclick="closeModal()" class="absolute top-4 right-4 text-slate-400 hover:text-slate-600">
                <i class="ph ph-x text-2xl"></i>
            </button>
            <div class="text-center">
                <div class="w-16 h-16 bg-teal-100 rounded-full flex items-center justify-center mx-auto mb-4">
                    <i class="ph ph-gift text-3xl text-teal-600"></i>
                </div>
                <h3 class="text-xl font-bold text-slate-900 mb-2">ì ì‹œë§Œìš”! ğŸ‘‹</h3>
                <p class="text-slate-500 mb-6 text-sm break-keep">
                    ë¶„ì„ ê²°ê³¼ê°€ ë„ì›€ì´ ë˜ì…¨ë‚˜ìš”?<br/>
                    ê°„ë‹¨í•œ ì„¤ë¬¸ì¡°ì‚¬ì— ì°¸ì—¬í•´ì£¼ì‹œë©´<br/>
                    ë” ì¢‹ì€ ì„œë¹„ìŠ¤ë¥¼ ë§Œë“œëŠ” ë° í° í˜ì´ ë©ë‹ˆë‹¤.
                </p>
                <div class="flex flex-col gap-3">
                    <button onclick="goToSurvey()" class="w-full bg-teal-600 text-white py-3 rounded-xl font-bold hover:bg-teal-700 transition-colors shadow-lg shadow-teal-200">
                        ë„¤, ì°¸ì—¬í• ê²Œìš”!
                    </button>
                    <button onclick="closeModal()" class="w-full text-slate-400 hover:text-slate-600 text-sm py-2">
                        ê´œì°®ìŠµë‹ˆë‹¤, ë‹¤ìŒì— í• ê²Œìš”.
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- ë¹„ë””ì˜¤ ëª¨ë‹¬ -->
    <div id="video-modal" class="fixed inset-0 z-[60] modal-backdrop flex items-center justify-center p-4 hidden">
        <div class="bg-black w-full max-w-2xl rounded-2xl overflow-hidden shadow-2xl relative">
            <div class="p-4 flex justify-between items-center text-white bg-gray-900">
                <h3 id="video-title" class="font-bold text-lg">ìš´ë™ ê°€ì´ë“œ</h3>
                <button onclick="closeVideoModal()" class="text-gray-300 hover:text-white">
                    <i class="ph ph-x text-2xl"></i>
                </button>
            </div>
            <div class="video-container">
                <iframe id="video-frame" src="" frameborder="0" allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture" allowfullscreen></iframe>
            </div>
        </div>
    </div>

    <!-- JavaScript ë¡œì§ -->
    <script>
        const SURVEY_URL = "https://naver.me/FTMiqIuh"; 
        
        // [ì—…ë°ì´íŠ¸] ìš´ë™ ë°ì´í„° (ìƒì„¸ ë£¨í‹´ ì¶”ê°€ë¨)
        const EXERCISE_DATA = {
            "í˜ì´ìŠ¤ í’€": {
                id: "90V84gRS2_Y", // ìœ íŠœë¸Œ ID
                desc: "ì¼€ì´ë¸”ì„ ëˆˆë†’ì´ë¡œ ë‹¹ê²¨ ë“± ìƒë¶€ë¥¼ ìˆ˜ì¶•í•©ë‹ˆë‹¤.",
                set: "3ì„¸íŠ¸",
                count: "15íšŒ",
                rest: "1ë¶„ íœ´ì‹"
            },
            "ìˆ„ë” í”„ë ˆìŠ¤": {
                id: "qEwKCR5JCog",
                desc: "íŒ”ê¿ˆì¹˜ê°€ ì§ê°ì´ ë˜ë„ë¡ ë‚´ë ¸ë‹¤ê°€ ë¨¸ë¦¬ ìœ„ë¡œ ì­‰ ë°€ì–´ ì˜¬ë¦½ë‹ˆë‹¤.",
                set: "3ì„¸íŠ¸",
                count: "12íšŒ",
                rest: "90ì´ˆ íœ´ì‹"
            },
            "ëª© í´ê¸°": {
                id: "wQylqaCl8Zo",
                desc: "ê°€ìŠ´ì„ í´ê³  í„±ì„ ë‹¹ê¸´ ì±„, ë¨¸ë¦¬ë¥¼ ì²œì²œíˆ ë’¤ë¡œ ì –í˜€ 5ì´ˆê°„ ìœ ì§€í•©ë‹ˆë‹¤.",
                set: "3ì„¸íŠ¸",
                count: "10íšŒ",
                rest: "30ì´ˆ íœ´ì‹"
            },
            "ì—… ë¼ì´íŠ¸ ë¡œìš°": {
                id: "amcu-8CUSQw",
                desc: "ë°”ë¥¼ ëª¸ì— ìŠ¤ì¹˜ë“¯ í„± ë°‘ê¹Œì§€ ë‹¹ê²¨ ì˜¬ë¦½ë‹ˆë‹¤. íŒ”ê¿ˆì¹˜ê°€ ì†ë³´ë‹¤ ë†’ê²Œ ìœ ì§€í•˜ì„¸ìš”.",
                set: "3ì„¸íŠ¸",
                count: "12íšŒ",
                rest: "1ë¶„ íœ´ì‹"
            }
        };

        let poseNet = null;
        let isSdkLoaded = false;
        let frontImgData = null;
        let sideImgData = null;
        let hasShownExitModal = false;

        // DOM Elements
        const frontInput = document.getElementById('front-input');
        const sideInput = document.getElementById('side-input');
        const frontPreview = document.getElementById('front-preview');
        const sidePreview = document.getElementById('side-preview');
        const frontPlaceholder = document.getElementById('front-placeholder');
        const sidePlaceholder = document.getElementById('side-placeholder');
        const frontResetBtn = document.getElementById('front-reset-btn');
        const sideResetBtn = document.getElementById('side-reset-btn');
        const analyzeBtn = document.getElementById('analyze-btn');
        const uploadView = document.getElementById('upload-view');
        const resultView = document.getElementById('result-view');
        const resultCards = document.getElementById('result-cards');
        const resetAllBtn = document.getElementById('reset-all-btn');
        const exitModal = document.getElementById('exit-modal');
        const videoModal = document.getElementById('video-modal');
        const videoFrame = document.getElementById('video-frame');
        const videoTitle = document.getElementById('video-title');

        // 1. ì´ˆê¸°í™” ë° MediaPipe ë¡œë“œ
        window.onload = async () => {
            try {
                const pose = new Pose({locateFile: (file) => {
                    return `https://cdn.jsdelivr.net/npm/@mediapipe/pose/${file}`;
                }});
                
                pose.setOptions({
                    modelComplexity: 1,
                    smoothLandmarks: false,
                    minDetectionConfidence: 0.5,
                    minTrackingConfidence: 0.5
                });
                
                poseNet = pose;
                isSdkLoaded = true;
                updateAnalyzeButton();
                initExitIntent();

            } catch (error) {
                console.error("MediaPipe Load Error:", error);
                analyzeBtn.textContent = "AI ì—”ì§„ ë¡œë“œ ì‹¤íŒ¨";
            }
        };

        // 2. ì´ë¯¸ì§€ ì²˜ë¦¬ í•¨ìˆ˜ë“¤
        function handleFile(input, preview, placeholder, resetBtn, type) {
            if (input.files && input.files[0]) {
                const reader = new FileReader();
                reader.onload = (e) => {
                    preview.src = e.target.result;
                    preview.classList.remove('hidden');
                    placeholder.classList.add('hidden');
                    resetBtn.classList.remove('hidden');
                    
                    if(type === 'front') frontImgData = e.target.result;
                    else sideImgData = e.target.result;
                    
                    updateAnalyzeButton();
                };
                reader.readAsDataURL(input.files[0]);
            }
        }

        frontInput.addEventListener('change', () => handleFile(frontInput, frontPreview, frontPlaceholder, frontResetBtn, 'front'));
        sideInput.addEventListener('change', () => handleFile(sideInput, sidePreview, sidePlaceholder, sideResetBtn, 'side'));

        frontResetBtn.addEventListener('click', () => {
            frontInput.value = '';
            frontImgData = null;
            frontPreview.src = '';
            frontPreview.classList.add('hidden');
            frontPlaceholder.classList.remove('hidden');
            frontResetBtn.classList.add('hidden');
            updateAnalyzeButton();
        });

        sideResetBtn.addEventListener('click', () => {
            sideInput.value = '';
            sideImgData = null;
            sidePreview.src = '';
            sidePreview.classList.add('hidden');
            sidePlaceholder.classList.remove('hidden');
            sideResetBtn.classList.add('hidden');
            updateAnalyzeButton();
        });

        function updateAnalyzeButton() {
            if (!isSdkLoaded) {
                analyzeBtn.textContent = "AI ì—”ì§„ ë¡œë”© ì¤‘...";
                analyzeBtn.disabled = true;
                analyzeBtn.className = "w-full md:w-auto px-10 py-4 rounded-xl font-bold text-lg shadow-xl transition-all bg-slate-200 text-slate-400 cursor-not-allowed";
            } else if (frontImgData && sideImgData) {
                analyzeBtn.textContent = "ì²´í˜• ë¶„ì„ ì‹œì‘í•˜ê¸°";
                analyzeBtn.disabled = false;
                analyzeBtn.className = "w-full md:w-auto px-10 py-4 rounded-xl font-bold text-lg shadow-xl shadow-teal-100 transition-all transform active:scale-95 bg-teal-600 hover:bg-teal-700 text-white cursor-pointer";
            } else {
                analyzeBtn.textContent = "ì‚¬ì§„ ë‘ ì¥ì„ ëª¨ë‘ ì˜¬ë ¤ì£¼ì„¸ìš”";
                analyzeBtn.disabled = true;
                analyzeBtn.className = "w-full md:w-auto px-10 py-4 rounded-xl font-bold text-lg shadow-xl transition-all bg-slate-200 text-slate-400 cursor-not-allowed";
            }
        }

        // AI ë¶„ì„ ì‹¤í–‰
        analyzeBtn.addEventListener('click', async () => {
            if (!frontImgData || !sideImgData || !poseNet) return;

            analyzeBtn.disabled = true;
            analyzeBtn.innerHTML = '<div class="flex items-center justify-center space-x-2"><div class="spinner border-2 w-5 h-5"></div><span>ì •ë°€ ë¶„ì„ ì¤‘...</span></div>';

            try {
                const frontCanvas = document.getElementById('front-canvas');
                const frontRes = await processImage(frontImgData, frontCanvas, 'front');
                const sideCanvas = document.getElementById('side-canvas');
                const sideRes = await processImage(sideImgData, sideCanvas, 'side');

                const diagnosis = calculateDiagnosis(frontRes, sideRes);
                displayResults(diagnosis);
                
                uploadView.classList.add('hidden');
                resultView.classList.remove('hidden');
                
            } catch (error) {
                console.error(error);
                alert("ë¶„ì„ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤. ì‚¬ì§„ì„ í™•ì¸í•´ì£¼ì„¸ìš”.");
            } finally {
                updateAnalyzeButton();
            }
        });

        function processImage(src, canvas, type) {
            return new Promise((resolve) => {
                const img = new Image();
                img.src = src;
                img.onload = async () => {
                    canvas.width = img.width;
                    canvas.height = img.height;
                    const ctx = canvas.getContext('2d');
                    ctx.drawImage(img, 0, 0);

                    const onResults = (res) => {
                        if (res.poseLandmarks) {
                            drawConnectors(ctx, res.poseLandmarks, POSE_CONNECTIONS, {color: 'rgba(0, 255, 0, 0.5)', lineWidth: 4});
                            drawDiagnosticLines(ctx, res.poseLandmarks, type);
                        }
                        resolve(res.poseLandmarks);
                    };
                    poseNet.onResults(onResults);
                    await poseNet.send({image: img});
                };
            });
        }

        function calculateAngle(p1, p2) {
            const dx = Math.abs(p1.x - p2.x);
            const dy = Math.abs(p1.y - p2.y);
            const theta = Math.atan2(dx, dy); 
            const degree = theta * (180 / Math.PI);
            return degree;
        }

        function calculateShoulderSlope(p1, p2) {
            const dy = Math.abs(p1.y - p2.y);
            const dx = Math.abs(p1.x - p2.x);
            const theta = Math.atan2(dy, dx);
            return theta * (180 / Math.PI);
        }

        function drawDiagnosticLines(ctx, landmarks, type) {
            ctx.save();
            ctx.lineWidth = 8;
            ctx.font = "bold 20px Arial";

            if (type === 'side') {
                const ear = landmarks[7]; 
                const shoulder = landmarks[11];
                const ex = ear.x * ctx.canvas.width;
                const ey = ear.y * ctx.canvas.height;
                const sx = shoulder.x * ctx.canvas.width;
                const sy = shoulder.y * ctx.canvas.height;

                ctx.beginPath();
                ctx.strokeStyle = "#3b82f6";
                ctx.setLineDash([5, 5]);
                ctx.moveTo(sx, sy);
                ctx.lineTo(sx, ey - 60);
                ctx.stroke();

                ctx.beginPath();
                ctx.setLineDash([]);
                ctx.strokeStyle = "#ef4444";
                ctx.moveTo(sx, sy);
                ctx.lineTo(ex, ey);
                ctx.stroke();
                
                ctx.fillStyle = "#ef4444";
                ctx.beginPath(); ctx.arc(ex, ey, 10, 0, 2*Math.PI); ctx.fill();
                ctx.fillStyle = "#3b82f6";
                ctx.beginPath(); ctx.arc(sx, sy, 10, 0, 2*Math.PI); ctx.fill();

            } else {
                const l = landmarks[11];
                const r = landmarks[12];
                const lx = l.x * ctx.canvas.width;
                const ly = l.y * ctx.canvas.height;
                const rx = r.x * ctx.canvas.width;
                const ry = r.y * ctx.canvas.height;

                ctx.beginPath();
                ctx.strokeStyle = "#ef4444";
                ctx.setLineDash([]);
                ctx.moveTo(lx, ly);
                ctx.lineTo(rx, ry);
                ctx.stroke();

                const highY = Math.min(ly, ry);
                ctx.beginPath();
                ctx.strokeStyle = "#3b82f6";
                ctx.setLineDash([5, 5]);
                ctx.moveTo(lx - 20, highY);
                ctx.lineTo(rx + 20, highY);
                ctx.stroke();
            }
            ctx.restore();
        }

        function calculateDiagnosis(front, side) {
            let result = {
                rounded: { status: 'ì–‘í˜¸', text: 'ì •ë©´ ì–´ê¹¨ ê· í˜•ì´ ì•ˆì •ì ì…ë‹ˆë‹¤.' },
                turtle: { status: 'ì–‘í˜¸', text: 'ì¸¡ë©´ ëª© ì •ë ¬ì´ ë°”ë¦…ë‹ˆë‹¤.' }
            };

            if (side) {
                const isLeft = side[11].visibility > side[12].visibility;
                const shoulder = isLeft ? side[11] : side[12];
                const ear = isLeft ? side[7] : side[8];
                const angle = calculateAngle(ear, shoulder);
                
                if (angle > 40) {
                    result.turtle = { status: 'ì‹¬ê°', text: `ëª©ì´ ìˆ˜ì§ ê¸°ì¤€ ${angle.toFixed(1)}ë„ ì•ìœ¼ë¡œ êµ½ì–´ìˆìŠµë‹ˆë‹¤.` };
                } else if (angle > 20) {
                    result.turtle = { status: 'ì£¼ì˜', text: `ëª©ì´ ìˆ˜ì§ ê¸°ì¤€ ${angle.toFixed(1)}ë„ ê¸°ìš¸ì–´ì ¸ ìˆìŠµë‹ˆë‹¤.` };
                } else {
                    result.turtle = { status: 'ì–‘í˜¸', text: `ëª© ê°ë„ê°€ ${angle.toFixed(1)}ë„ë¡œ ì •ìƒ ë²”ìœ„ì…ë‹ˆë‹¤.` };
                }
            } else {
                result.turtle = { status: 'ì¸¡ì •ë¶ˆê°€', text: 'ì¸¡ë©´ ì‚¬ì§„ì—ì„œ ì¸ë¬¼ì„ ì°¾ì§€ ëª»í–ˆìŠµë‹ˆë‹¤.' };
            }

            if (front) {
                const l = front[11];
                const r = front[12];
                const slopeAngle = calculateShoulderSlope(l, r);

                if (slopeAngle > 3.0) {
                    result.rounded = { status: 'ë¶ˆê· í˜•', text: `ì–‘ìª½ ì–´ê¹¨ ë†’ì´ê°€ ${slopeAngle.toFixed(1)}ë„ ê°€ëŸ‰ ì°¨ì´ë‚©ë‹ˆë‹¤.` };
                } else if (slopeAngle > 1.5) {
                    result.rounded = { status: 'ì£¼ì˜', text: `ì–´ê¹¨ ê· í˜•ì´ ${slopeAngle.toFixed(1)}ë„ ì •ë„ ë¯¸ì„¸í•˜ê²Œ í‹€ì–´ì ¸ ìˆìŠµë‹ˆë‹¤.` };
                } else {
                    result.rounded = { status: 'ì–‘í˜¸', text: `ì–´ê¹¨ ìˆ˜í‰ ê°ë„ê°€ ${slopeAngle.toFixed(1)}ë„ë¡œ ì•ˆì •ì ì…ë‹ˆë‹¤.` };
                }
            } else {
                result.rounded = { status: 'ì¸¡ì •ë¶ˆê°€', text: 'ì •ë©´ ì‚¬ì§„ì—ì„œ ì¸ë¬¼ì„ ì°¾ì§€ ëª»í–ˆìŠµë‹ˆë‹¤.' };
            }
            
            return result;
        }

        // [í•¨ìˆ˜ ì¶”ê°€] ìš´ë™ ì¹´ë“œ ìƒì„± í—¬í¼ (ìƒì„¸ ì •ë³´ í¬í•¨)
        function renderExerciseCard(name) {
            const data = EXERCISE_DATA[name];
            return `
                <div onclick="openVideoModal('${name}')" class="bg-slate-50 p-4 rounded-xl border border-slate-100 cursor-pointer hover:bg-slate-100 transition-colors group">
                    <div class="flex justify-between items-start mb-2">
                        <strong class="text-slate-900 group-hover:text-teal-600 text-base flex items-center gap-1">
                             ${name}
                        </strong>
                        <i class="ph ph-play-circle text-2xl text-slate-400 group-hover:text-teal-500"></i>
                    </div>
                    <p class="text-xs text-slate-600 mb-3 break-keep leading-relaxed">${data.desc}</p>
                    <div class="flex flex-wrap gap-2 text-[11px] font-medium text-slate-500">
                        <span class="bg-white px-2 py-1 rounded border border-slate-200 shadow-sm flex items-center gap-1 whitespace-nowrap"><i class="ph-bold ph-arrows-clockwise text-teal-500"></i> ${data.set}</span>
                        <span class="bg-white px-2 py-1 rounded border border-slate-200 shadow-sm flex items-center gap-1 whitespace-nowrap"><i class="ph-bold ph-lightning text-yellow-500"></i> ${data.count}</span>
                        <span class="bg-white px-2 py-1 rounded border border-slate-200 shadow-sm flex items-center gap-1 whitespace-nowrap"><i class="ph-bold ph-coffee text-orange-400"></i> ${data.rest}</span>
                    </div>
                </div>
            `;
        }

        // ê²°ê³¼ í‘œì‹œ í•¨ìˆ˜
        function displayResults(data) {
            const getColor = (s) => s === 'ì–‘í˜¸' ? 'bg-green-500' : (s === 'ì£¼ì˜' ? 'bg-yellow-500' : 'bg-red-500');
            const getBadge = (s) => s === 'ì–‘í˜¸' ? 'bg-green-100 text-green-700' : (s === 'ì£¼ì˜' ? 'bg-yellow-100 text-yellow-700' : 'bg-red-100 text-red-700');

            resultCards.innerHTML = `
                <!-- Rounded Shoulder Result -->
                <div class="bg-white rounded-2xl p-6 shadow-sm border border-slate-100 overflow-hidden relative">
                    <div class="absolute top-0 left-0 w-2 h-full ${getColor(data.rounded.status)}"></div>
                    <div class="pl-4">
                        <div class="flex justify-between items-center mb-4">
                            <div><h3 class="text-lg font-bold text-slate-800">ì–´ê¹¨ ê· í˜• (Front)</h3></div>
                            <span class="px-3 py-1 rounded-full text-sm font-bold whitespace-nowrap shrink-0 ${getBadge(data.rounded.status)}">${data.rounded.status}</span>
                        </div>
                        <p class="text-slate-700 mb-6 font-medium bg-slate-50 p-3 rounded-lg">${data.rounded.text}</p>
                        ${data.rounded.status !== 'ì–‘í˜¸' && data.rounded.status !== 'ì¸¡ì •ë¶ˆê°€' ? `
                        <div class="space-y-3">
                            <h4 class="font-bold text-sm text-slate-900 flex items-center gap-2"><i class="ph ph-youtube-logo text-red-600 text-lg"></i> ì¶”ì²œ ìš´ë™ (í´ë¦­í•˜ì—¬ ì¬ìƒ)</h4>
                            <div class="grid grid-cols-1 sm:grid-cols-2 gap-3">
                                ${renderExerciseCard("í˜ì´ìŠ¤ í’€")}
                                ${renderExerciseCard("ìˆ„ë” í”„ë ˆìŠ¤")}
                            </div>
                        </div>` : ''}
                    </div>
                </div>

                <!-- Turtle Neck Result -->
                <div class="bg-white rounded-2xl p-6 shadow-sm border border-slate-100 overflow-hidden relative">
                    <div class="absolute top-0 left-0 w-2 h-full ${getColor(data.turtle.status)}"></div>
                    <div class="pl-4">
                        <div class="flex justify-between items-center mb-4">
                            <div><h3 class="text-lg font-bold text-slate-800">ê±°ë¶ëª© (Side)</h3></div>
                            <span class="px-3 py-1 rounded-full text-sm font-bold whitespace-nowrap shrink-0 ${getBadge(data.turtle.status)}">${data.turtle.status}</span>
                        </div>
                        <p class="text-slate-700 mb-6 font-medium bg-slate-50 p-3 rounded-lg">${data.turtle.text}</p>
                        ${data.turtle.status !== 'ì–‘í˜¸' && data.turtle.status !== 'ì¸¡ì •ë¶ˆê°€' ? `
                        <div class="space-y-3">
                            <h4 class="font-bold text-sm text-slate-900 flex items-center gap-2"><i class="ph ph-youtube-logo text-red-600 text-lg"></i> ì¶”ì²œ ìš´ë™ (í´ë¦­í•˜ì—¬ ì¬ìƒ)</h4>
                            <div class="grid grid-cols-1 sm:grid-cols-2 gap-3">
                                ${renderExerciseCard("ëª© í´ê¸°")}
                                ${renderExerciseCard("ì—… ë¼ì´íŠ¸ ë¡œìš°")}
                            </div>
                        </div>` : ''}
                    </div>
                </div>
            `;
        }

        // ë¹„ë””ì˜¤ ëª¨ë‹¬ ê´€ë ¨ í•¨ìˆ˜
        function openVideoModal(exerciseName) {
            const data = EXERCISE_DATA[exerciseName];
            if (!data) return;

            let videoId = data.id;
            // ë§Œì•½ URLì„ í†µì§¸ë¡œ ë„£ì—ˆì„ ê²½ìš° IDë§Œ ì¶”ì¶œ
            if (videoId.includes('youtu.be/')) {
                videoId = videoId.split('youtu.be/')[1].split('?')[0];
            } else if (videoId.includes('v=')) {
                videoId = videoId.split('v=')[1].split('&')[0];
            }

            videoTitle.textContent = exerciseName + " ê°€ì´ë“œ";
            // mute=1, playsinline=1ì€ ëª¨ë°”ì¼ ìë™ì¬ìƒ ì •ì±…ì„ ìœ„í•´ í•„ìˆ˜
            videoFrame.src = `https://www.youtube.com/embed/${videoId}?autoplay=1&mute=1&playsinline=1&rel=0`;
            videoModal.classList.remove('hidden');
        }

        function closeVideoModal() {
            videoModal.classList.add('hidden');
            videoFrame.src = ""; // ì˜ìƒ ì¤‘ì§€
        }

        resetAllBtn.addEventListener('click', () => { location.reload(); });

        function goToSurvey() { window.location.href = SURVEY_URL; }
        function closeModal() { exitModal.classList.add('hidden'); }

        function initExitIntent() {
            document.addEventListener('mouseleave', (e) => {
                if (e.clientY <= 0 && !hasShownExitModal) { showModal(); }
            });
            window.history.pushState({ page: 1 }, "", ""); 
            window.onpopstate = function(event) {
                if (!hasShownExitModal) {
                    window.history.pushState({ page: 1 }, "", "");
                    showModal();
                }
            };
        }

        function showModal() {
            hasShownExitModal = true;
            exitModal.classList.remove('hidden');
        }
    </script>
</body>
</html>