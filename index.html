<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>AI Posture Clinic - ë‚¨ì–‘ì£¼ë„ì‹œê³µì‚¬</title>
    
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- Phosphor Icons -->
    <script src="https://unpkg.com/@phosphor-icons/web"></script>

    <!-- MediaPipe Pose -->
    <script src="https://cdn.jsdelivr.net/npm/@mediapipe/pose/pose.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@mediapipe/drawing_utils/drawing_utils.js"></script>

    <style>
        @import url('https://fonts.googleapis.com/css2?family=Noto+Sans+KR:wght@300;400;500;700&display=swap');
        body { font-family: 'Noto Sans KR', sans-serif; background-color: #f8fafc; touch-action: manipulation; }
        
        .hidden { display: none !important; }
        
        /* ì• ë‹ˆë©”ì´ì…˜ */
        .fade-in { animation: fadeIn 0.5s ease-out; }
        .pop-in { animation: popIn 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275); }
        
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
        @keyframes popIn { from { opacity: 0; transform: scale(0.9); } to { opacity: 1; transform: scale(1); } }
        
        .modal-backdrop {
            background-color: rgba(0, 0, 0, 0.6);
            backdrop-filter: blur(4px);
        }
        
        /* ìŠ¤í”¼ë„ˆ */
        .spinner {
            border: 4px solid rgba(255, 255, 255, 0.3);
            border-radius: 50%;
            border-top: 4px solid #0d9488;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
        }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
    </style>
</head>
<body>

    <!-- í—¤ë” -->
    <header class="bg-white shadow-sm sticky top-0 z-10">
        <div class="max-w-3xl mx-auto px-4 py-4 flex items-center justify-between">
            <div class="flex items-center space-x-2">
                <div class="bg-teal-600 p-2 rounded-lg text-white"><i class="ph ph-camera text-xl"></i></div>
                <h1 class="text-xl font-bold tracking-tight text-slate-900">AI Posture Clinic</h1>
            </div>
            <span class="text-xs font-bold bg-teal-50 text-teal-700 px-3 py-1 rounded-full border border-teal-100">Version 1.0</span>
        </div>
    </header>

    <main class="max-w-3xl mx-auto px-4 mt-8 pb-24">
        
        <!-- 1. ì—…ë¡œë“œ í™”ë©´ (ê¸°ë³¸ í‘œì‹œ) -->
        <div id="upload-view" class="space-y-8 fade-in">
            <div class="text-center space-y-3">
                <h2 class="text-3xl font-extrabold text-slate-900">AI ê¸°ë°˜ ì²´í˜• ë¶„ì„ <span class="text-teal-600"><br/>ìš´ë™ í”„ë¡œê·¸ë¨ ì†”ë£¨ì…˜</span></h2>
                <p class="text-slate-500 max-w-md mx-auto leading-relaxed">ì‚¬ì§„ ë‘ ì¥ìœ¼ë¡œ ê±°ë¶ëª©ê³¼ ë¼ìš´ë“œ ìˆ„ë”<br/>ìœ„í—˜ë„ë¥¼ í™•ì¸í•˜ê³  ìš´ë™ì„ ì¶”ì²œ ë°›ì•„ë³´ì„¸ìš”.</p>
            </div>

            <div class="grid grid-cols-1 md:grid-cols-2 gap-8 justify-items-center">
                
                <!-- ì •ë©´ ì‚¬ì§„ ì—…ë¡œë“œ ë°•ìŠ¤ -->
                <div class="flex flex-col gap-2 w-[200px]">
                    <div id="front-box" class="relative border-2 border-dashed border-slate-300 rounded-2xl p-6 w-[200px] h-[600px] flex flex-col items-center justify-center transition-all duration-300 overflow-hidden bg-white hover:border-teal-400">
                        <!-- ì´ë¯¸ì§€ ë¯¸ë¦¬ë³´ê¸° (ë™ì ìœ¼ë¡œ ì¶”ê°€ë¨) -->
                        <img id="front-preview" class="absolute inset-0 w-full h-full object-contain hidden z-10 bg-black" />
                        
                        <!-- ì´ˆê¸° ì•ˆë‚´ í™”ë©´ -->
                        <div id="front-placeholder" class="flex flex-col items-center w-full h-full relative z-0">
                            <img src="front.jpg" class="absolute inset-0 w-full h-full object-cover opacity-30 pointer-events-none" onerror="this.style.display='none'">
                            <div class="z-10 flex flex-col items-center justify-center h-full gap-4 w-full">
                                <div class="text-center bg-white/80 p-3 rounded-xl backdrop-blur-sm shadow-sm w-full">
                                    <span class="font-bold text-slate-700 block">ì •ë©´ ì‚¬ì§„</span>
                                    <span class="text-xs text-slate-500">ì „ì‹ ì´ ë³´ì´ê²Œ<br/>ì°¨ë · ìì„¸</span>
                                </div>
                                <div class="flex flex-col gap-2 w-full px-4">
                                    <label class="cursor-pointer bg-teal-600 text-white py-3 rounded-xl text-sm font-bold shadow-md hover:bg-teal-700 transition-colors text-center flex items-center justify-center gap-2">
                                        <i class="ph ph-upload-simple text-lg"></i> ì‚¬ì§„ ì—…ë¡œë“œ
                                        <input type="file" id="front-input" accept="image/*" class="hidden">
                                    </label>
                                </div>
                            </div>
                        </div>
                        
                        <!-- ì‚­ì œ ë²„íŠ¼ -->
                        <button id="front-reset-btn" class="hidden absolute top-2 right-2 bg-black/50 text-white p-2 rounded-full hover:bg-black/70 transition-colors z-20">
                            <i class="ph ph-arrows-clockwise text-lg"></i>
                        </button>
                    </div>
                </div>

                <!-- ì¸¡ë©´ ì‚¬ì§„ ì—…ë¡œë“œ ë°•ìŠ¤ -->
                <div class="flex flex-col gap-2 w-[200px]">
                    <div id="side-box" class="relative border-2 border-dashed border-slate-300 rounded-2xl p-6 w-[200px] h-[600px] flex flex-col items-center justify-center transition-all duration-300 overflow-hidden bg-white hover:border-teal-400">
                        <img id="side-preview" class="absolute inset-0 w-full h-full object-contain hidden z-10 bg-black" />
                        
                        <div id="side-placeholder" class="flex flex-col items-center w-full h-full relative z-0">
                            <img src="side.jpg" class="absolute inset-0 w-full h-full object-cover opacity-30 pointer-events-none" onerror="this.style.display='none'">
                            <div class="z-10 flex flex-col items-center justify-center h-full gap-4 w-full">
                                <div class="text-center bg-white/80 p-3 rounded-xl backdrop-blur-sm shadow-sm w-full">
                                    <span class="font-bold text-slate-700 block">ì¸¡ë©´ ì‚¬ì§„</span>
                                    <span class="text-xs text-slate-500">ì „ì‹ ì´ ë³´ì´ê²Œ<br/>ê·€/ì–´ê¹¨ ë…¸ì¶œ</span>
                                </div>
                                <div class="flex flex-col gap-2 w-full px-4">
                                    <label class="cursor-pointer bg-teal-600 text-white py-3 rounded-xl text-sm font-bold shadow-md hover:bg-teal-700 transition-colors text-center flex items-center justify-center gap-2">
                                        <i class="ph ph-upload-simple text-lg"></i> ì‚¬ì§„ ì—…ë¡œë“œ
                                        <input type="file" id="side-input" accept="image/*" class="hidden">
                                    </label>
                                </div>
                            </div>
                        </div>

                        <button id="side-reset-btn" class="hidden absolute top-2 right-2 bg-black/50 text-white p-2 rounded-full hover:bg-black/70 transition-colors z-20">
                            <i class="ph ph-arrows-clockwise text-lg"></i>
                        </button>
                    </div>
                </div>
            </div>

            <div class="flex justify-center pt-2">
                <button id="analyze-btn" class="w-full md:w-auto px-10 py-4 rounded-xl font-bold text-lg shadow-xl shadow-teal-100 transition-all transform active:scale-95 bg-slate-200 text-slate-400 cursor-not-allowed" disabled>
                    AI ì—”ì§„ ë¡œë”© ì¤‘...
                </button>
            </div>
            
            <div class="bg-white p-4 rounded-xl border border-slate-100 shadow-sm">
                <div class="flex items-start gap-3">
                    <i class="ph ph-warning text-yellow-500 text-xl mt-0.5"></i>
                    <div class="text-xs text-slate-500 leading-relaxed">
                        <strong class="text-slate-700 block mb-1">ì´¬ì˜ ê°€ì´ë“œ</strong>
                        ì •í™•í•œ ë¶„ì„ì„ ìœ„í•´ í—ë í•œ ì˜·ë³´ë‹¤ëŠ” <strong>ëª¸ì˜ ë¼ì¸ì´ ë“œëŸ¬ë‚˜ëŠ” ì˜·</strong>ì„ ì…ê³  ì´¬ì˜í•´ì£¼ì„¸ìš”.
                        ëª¨ë°”ì¼ì—ì„œëŠ” 'ì‚¬ì§„ ì—…ë¡œë“œ' ë²„íŠ¼ì„ ëˆ„ë¥´ë©´ ì¹´ë©”ë¼ ë˜ëŠ” ê°¤ëŸ¬ë¦¬ë¥¼ ì„ íƒí•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.
                    </div>
                </div>
            </div>
        </div>

        <!-- 2. ë¶„ì„ ê²°ê³¼ í™”ë©´ (ìˆ¨ê¹€) -->
        <div id="result-view" class="space-y-8 hidden fade-in">
            <div class="text-center space-y-2">
                <h2 class="text-2xl font-bold text-slate-900">ë¶„ì„ ì™„ë£Œ</h2>
                <p class="text-slate-500 text-sm">AIê°€ ë¶„ì„í•œ ì²´í˜• ê²°ê³¼ì…ë‹ˆë‹¤.</p>
            </div>

            <!-- ìº”ë²„ìŠ¤ (ê²°ê³¼ ì‹œê°í™”) -->
            <div class="grid grid-cols-2 gap-4 mb-8">
                <div class="relative">
                    <span class="absolute top-2 left-2 bg-black/60 text-white text-xs px-2 py-1 rounded">ì •ë©´ ë¶„ì„</span>
                    <canvas id="front-canvas" class="w-full h-auto rounded-lg border border-slate-200 bg-black"></canvas>
                </div>
                <div class="relative">
                    <span class="absolute top-2 left-2 bg-black/60 text-white text-xs px-2 py-1 rounded">ì¸¡ë©´ ë¶„ì„</span>
                    <canvas id="side-canvas" class="w-full h-auto rounded-lg border border-slate-200 bg-black"></canvas>
                </div>
            </div>

            <div id="result-cards" class="grid gap-6">
                <!-- ê²°ê³¼ ì¹´ë“œê°€ JSë¡œ ì—¬ê¸°ì— ì‚½ì…ë©ë‹ˆë‹¤ -->
            </div>

            <button id="reset-all-btn" class="w-full bg-slate-800 text-white py-4 rounded-xl font-bold hover:bg-slate-900 transition-colors shadow-lg flex items-center justify-center gap-2 mt-8">
                <i class="ph ph-arrows-clockwise text-xl"></i> ë‹¤ë¥¸ ì‚¬ì§„ìœ¼ë¡œ ë‹¤ì‹œ ë¶„ì„í•˜ê¸°
            </button>
        </div>

    </main>

    <footer class="mt-12 text-center text-slate-400 text-sm pb-8">
        &copy; 2026 ë‚¨ì–‘ì£¼ë„ì‹œê³µì‚¬ ì „ëµê¸°íšë¶€ AI Posture Clinic.
    </footer>

    <!-- ì„¤ë¬¸ì¡°ì‚¬ í”Œë¡œíŒ… ë²„íŠ¼ -->
    <button onclick="goToSurvey()" class="fixed bottom-6 right-6 bg-slate-900 hover:bg-teal-600 text-white p-4 rounded-full shadow-2xl transition-all z-40 flex items-center gap-2 group">
        <i class="ph ph-clipboard-text text-xl"></i>
        <span class="max-w-0 overflow-hidden group-hover:max-w-xs transition-all duration-300 whitespace-nowrap text-sm font-bold">ì„¤ë¬¸ì¡°ì‚¬ ì°¸ì—¬</span>
    </button>

    <!-- ì´íƒˆ ê°ì§€ ëª¨ë‹¬ -->
    <div id="exit-modal" class="fixed inset-0 z-50 modal-backdrop flex items-center justify-center p-4 hidden pop-in">
        <div class="bg-white rounded-2xl p-8 max-w-sm w-full shadow-2xl relative">
            <button onclick="closeModal()" class="absolute top-4 right-4 text-slate-400 hover:text-slate-600">
                <i class="ph ph-x text-2xl"></i>
            </button>
            <div class="text-center">
                <div class="w-16 h-16 bg-teal-100 rounded-full flex items-center justify-center mx-auto mb-4">
                    <i class="ph ph-gift text-3xl text-teal-600"></i>
                </div>
                <h3 class="text-xl font-bold text-slate-900 mb-2">ì ì‹œë§Œìš”! ğŸ‘‹</h3>
                <p class="text-slate-500 mb-6 text-sm break-keep">
                    ë¶„ì„ ê²°ê³¼ê°€ ë„ì›€ì´ ë˜ì…¨ë‚˜ìš”?<br/>
                    ê°„ë‹¨í•œ ì„¤ë¬¸ì¡°ì‚¬ì— ì°¸ì—¬í•´ì£¼ì‹œë©´<br/>
                    ë” ì¢‹ì€ ì„œë¹„ìŠ¤ë¥¼ ë§Œë“œëŠ” ë° í° í˜ì´ ë©ë‹ˆë‹¤.
                </p>
                <div class="flex flex-col gap-3">
                    <button onclick="goToSurvey()" class="w-full bg-teal-600 text-white py-3 rounded-xl font-bold hover:bg-teal-700 transition-colors shadow-lg shadow-teal-200">
                        ë„¤, ì°¸ì—¬í• ê²Œìš”!
                    </button>
                    <button onclick="closeModal()" class="w-full text-slate-400 hover:text-slate-600 text-sm py-2">
                        ê´œì°®ìŠµë‹ˆë‹¤, ë‹¤ìŒì— í• ê²Œìš”.
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- JavaScript ë¡œì§ -->
    <script>
        const SURVEY_URL = "https://naver.me/FTMiqIuh"; // ì„¤ë¬¸ì¡°ì‚¬ ë§í¬ ìˆ˜ì • í•„ìš”
        let poseNet = null;
        let isSdkLoaded = false;
        let frontImgData = null;
        let sideImgData = null;
        let hasShownExitModal = false;

        // DOM Elements
        const frontInput = document.getElementById('front-input');
        const sideInput = document.getElementById('side-input');
        const frontPreview = document.getElementById('front-preview');
        const sidePreview = document.getElementById('side-preview');
        const frontPlaceholder = document.getElementById('front-placeholder');
        const sidePlaceholder = document.getElementById('side-placeholder');
        const frontResetBtn = document.getElementById('front-reset-btn');
        const sideResetBtn = document.getElementById('side-reset-btn');
        const analyzeBtn = document.getElementById('analyze-btn');
        const uploadView = document.getElementById('upload-view');
        const resultView = document.getElementById('result-view');
        const resultCards = document.getElementById('result-cards');
        const resetAllBtn = document.getElementById('reset-all-btn');
        const exitModal = document.getElementById('exit-modal');

        // 1. ì´ˆê¸°í™” ë° MediaPipe ë¡œë“œ
        window.onload = async () => {
            try {
                const pose = new Pose({locateFile: (file) => {
                    return `https://cdn.jsdelivr.net/npm/@mediapipe/pose/${file}`;
                }});
                
                pose.setOptions({
                    modelComplexity: 1,
                    smoothLandmarks: false, // ì •ì  ì´ë¯¸ì§€ ëª¨ë“œ
                    minDetectionConfidence: 0.5,
                    minTrackingConfidence: 0.5
                });
                
                poseNet = pose;
                isSdkLoaded = true;
                updateAnalyzeButton();
                
                // ì´íƒˆ ê°ì§€ ì´ˆê¸°í™”
                initExitIntent();

            } catch (error) {
                console.error("MediaPipe Load Error:", error);
                analyzeBtn.textContent = "AI ì—”ì§„ ë¡œë“œ ì‹¤íŒ¨";
            }
        };

        // 2. ì´ë¯¸ì§€ ì—…ë¡œë“œ ì²˜ë¦¬
        function handleFile(input, preview, placeholder, resetBtn, type) {
            if (input.files && input.files[0]) {
                const reader = new FileReader();
                reader.onload = (e) => {
                    preview.src = e.target.result;
                    preview.classList.remove('hidden');
                    placeholder.classList.add('hidden');
                    resetBtn.classList.remove('hidden');
                    
                    if(type === 'front') frontImgData = e.target.result;
                    else sideImgData = e.target.result;
                    
                    updateAnalyzeButton();
                };
                reader.readAsDataURL(input.files[0]);
            }
        }

        frontInput.addEventListener('change', () => handleFile(frontInput, frontPreview, frontPlaceholder, frontResetBtn, 'front'));
        sideInput.addEventListener('change', () => handleFile(sideInput, sidePreview, sidePlaceholder, sideResetBtn, 'side'));

        // 3. ë¦¬ì…‹ ë²„íŠ¼ (ê°œë³„)
        frontResetBtn.addEventListener('click', () => {
            frontInput.value = '';
            frontImgData = null;
            frontPreview.src = '';
            frontPreview.classList.add('hidden');
            frontPlaceholder.classList.remove('hidden');
            frontResetBtn.classList.add('hidden');
            updateAnalyzeButton();
        });

        sideResetBtn.addEventListener('click', () => {
            sideInput.value = '';
            sideImgData = null;
            sidePreview.src = '';
            sidePreview.classList.add('hidden');
            sidePlaceholder.classList.remove('hidden');
            sideResetBtn.classList.add('hidden');
            updateAnalyzeButton();
        });

        // 4. ë¶„ì„ ë²„íŠ¼ ìƒíƒœ ì—…ë°ì´íŠ¸
        function updateAnalyzeButton() {
            if (!isSdkLoaded) {
                analyzeBtn.textContent = "AI ì—”ì§„ ë¡œë”© ì¤‘...";
                analyzeBtn.disabled = true;
                analyzeBtn.className = "w-full md:w-auto px-10 py-4 rounded-xl font-bold text-lg shadow-xl transition-all bg-slate-200 text-slate-400 cursor-not-allowed";
            } else if (frontImgData && sideImgData) {
                analyzeBtn.textContent = "ì²´í˜• ë¶„ì„ ì‹œì‘í•˜ê¸°";
                analyzeBtn.disabled = false;
                analyzeBtn.className = "w-full md:w-auto px-10 py-4 rounded-xl font-bold text-lg shadow-xl shadow-teal-100 transition-all transform active:scale-95 bg-teal-600 hover:bg-teal-700 text-white cursor-pointer";
            } else {
                analyzeBtn.textContent = "ì‚¬ì§„ ë‘ ì¥ì„ ëª¨ë‘ ì˜¬ë ¤ì£¼ì„¸ìš”";
                analyzeBtn.disabled = true;
                analyzeBtn.className = "w-full md:w-auto px-10 py-4 rounded-xl font-bold text-lg shadow-xl transition-all bg-slate-200 text-slate-400 cursor-not-allowed";
            }
        }

        // 5. AI ë¶„ì„ ì‹¤í–‰
        analyzeBtn.addEventListener('click', async () => {
            if (!frontImgData || !sideImgData || !poseNet) return;

            // ë¡œë”© UI
            analyzeBtn.disabled = true;
            analyzeBtn.innerHTML = '<div class="flex items-center justify-center space-x-2"><div class="spinner border-2 w-5 h-5"></div><span>ë¶„ì„ ì¤‘...</span></div>';

            try {
                // Front Process
                const frontCanvas = document.getElementById('front-canvas');
                const frontRes = await processImage(frontImgData, frontCanvas, 'front');
                
                // Side Process
                const sideCanvas = document.getElementById('side-canvas');
                const sideRes = await processImage(sideImgData, sideCanvas, 'side');

                // ê²°ê³¼ ê³„ì‚°
                const diagnosis = calculateDiagnosis(frontRes, sideRes);
                
                // ê²°ê³¼ í‘œì‹œ
                displayResults(diagnosis);
                
                // ë·° ì „í™˜
                uploadView.classList.add('hidden');
                resultView.classList.remove('hidden');
                
            } catch (error) {
                console.error(error);
                alert("ë¶„ì„ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤. ì‚¬ì§„ì„ í™•ì¸í•´ì£¼ì„¸ìš”.");
            } finally {
                updateAnalyzeButton();
            }
        });

        function processImage(src, canvas, type) {
            return new Promise((resolve) => {
                const img = new Image();
                img.src = src;
                img.onload = async () => {
                    canvas.width = img.width;
                    canvas.height = img.height;
                    const ctx = canvas.getContext('2d');
                    ctx.drawImage(img, 0, 0);

                    // ì¼íšŒì„± ë¦¬ìŠ¤ë„ˆ ë“±ë¡
                    const onResults = (res) => {
                        if (res.poseLandmarks) {
                            // ë¼ˆëŒ€ ê·¸ë¦¬ê¸°
                            drawConnectors(ctx, res.poseLandmarks, POSE_CONNECTIONS, {color: 'rgba(0, 255, 0, 0.6)', lineWidth: 4});
                            drawDiagnosticLines(ctx, res.poseLandmarks, type);
                        }
                        resolve(res.poseLandmarks);
                    };

                    // PoseNet ì„¤ì • ë° ì „ì†¡
                    // ì£¼ì˜: ë‹¨ì¼ ì´ë¯¸ì§€ ì²˜ë¦¬ë¥¼ ìœ„í•´ reset() í˜¸ì¶œ ê¶Œì¥ë˜ë‚˜ JS ë²„ì „ì—ì„œëŠ” ì§ì ‘ ì „ì†¡
                    poseNet.onResults(onResults);
                    await poseNet.send({image: img});
                };
            });
        }

        function drawDiagnosticLines(ctx, landmarks, type) {
            ctx.save();
            ctx.lineWidth = 8;
            ctx.font = "bold 16px Arial";

            if (type === 'side') {
                const ear = landmarks[7]; // Left Ear (ê°„ë‹¨íˆ ì™¼ìª½ ê¸°ì¤€)
                const shoulder = landmarks[11]; // Left Shoulder
                
                // ê°€ì‹œì„± ì²´í¬í•˜ì—¬ ë” ì˜ ë³´ì´ëŠ” ìª½ ì„ íƒ ê°€ëŠ¥
                // ì—¬ê¸°ì„œëŠ” ìƒëµí•˜ê³  ì™¼ìª½ ê¸°ì¤€ ì˜ˆì‹œ
                const ex = ear.x * ctx.canvas.width;
                const ey = ear.y * ctx.canvas.height;
                const sx = shoulder.x * ctx.canvas.width;
                const sy = shoulder.y * ctx.canvas.height;

                // ìˆ˜ì§ì„  (Blue)
                ctx.beginPath();
                ctx.strokeStyle = "#3b82f6";
                ctx.setLineDash([5, 5]);
                ctx.moveTo(sx, sy);
                ctx.lineTo(sx, ey - 50);
                ctx.stroke();

                // ì‹¤ì œ ê¸°ìš¸ê¸° (Red)
                ctx.beginPath();
                ctx.setLineDash([]);
                ctx.strokeStyle = "#ef4444";
                ctx.moveTo(sx, sy);
                ctx.lineTo(ex, ey);
                ctx.stroke();
                
                // ì 
                ctx.fillStyle = "#ef4444";
                ctx.beginPath(); ctx.arc(ex, ey, 8, 0, 2*Math.PI); ctx.fill();
                ctx.fillStyle = "#3b82f6";
                ctx.beginPath(); ctx.arc(sx, sy, 8, 0, 2*Math.PI); ctx.fill();

            } else {
                // Front: Shoulder levels
                const l = landmarks[11];
                const r = landmarks[12];
                
                const lx = l.x * ctx.canvas.width;
                const ly = l.y * ctx.canvas.height;
                const rx = r.x * ctx.canvas.width;
                const ry = r.y * ctx.canvas.height;

                ctx.beginPath();
                ctx.strokeStyle = "#ef4444";
                ctx.moveTo(lx, ly);
                ctx.lineTo(rx, ry);
                ctx.stroke();
            }
            ctx.restore();
        }

        function calculateDiagnosis(front, side) {
            let result = {
                rounded: { status: 'ì–‘í˜¸', text: 'ì •ë©´ ì–´ê¹¨ ê· í˜•ì´ ì–‘í˜¸í•©ë‹ˆë‹¤.' },
                turtle: { status: 'ì–‘í˜¸', text: 'ì¸¡ë©´ ëª© ì •ë ¬ì´ ì–‘í˜¸í•©ë‹ˆë‹¤.' }
            };

            // ê±°ë¶ëª© (Side)
            if (side) {
                const ear = side[7].visibility > side[8].visibility ? side[7] : side[8];
                const shoulder = side[11].visibility > side[12].visibility ? side[11] : side[12];
                const diff = Math.abs(ear.x - shoulder.x) * 100;
                
                if (diff > 5.5) result.turtle = { status: 'ì‹¬ê°', text: 'ê·€ê°€ ì–´ê¹¨ë³´ë‹¤ ë§ì´ ì•ìœ¼ë¡œ ë‚˜ì™€ìˆìŠµë‹ˆë‹¤.' };
                else if (diff > 2.5) result.turtle = { status: 'ì£¼ì˜', text: 'ê±°ë¶ëª© ì´ˆê¸° ì¦ìƒì´ ë³´ì…ë‹ˆë‹¤.' };
            }

            // ë¼ìš´ë“œìˆ„ë” (Front) - ê±°ë¶ëª©ê³¼ ì—°ê´€ì§€ì–´ ì¶”ì •
            if (front) {
                const l = front[11]; const r = front[12];
                const slope = Math.abs(l.y - r.y);
                
                if (slope > 0.04) {
                    result.rounded = { status: 'ë¶ˆê· í˜•', text: 'ì–‘ìª½ ì–´ê¹¨ ë†’ì´ê°€ ë‹¤ë¦…ë‹ˆë‹¤.' };
                } else if (result.turtle.status === 'ì‹¬ê°') {
                    result.rounded = { status: 'ì£¼ì˜', text: 'ê±°ë¶ëª©ìœ¼ë¡œ ì¸í•œ ë¼ìš´ë“œ ìˆ„ë”ê°€ ì˜ì‹¬ë©ë‹ˆë‹¤.' };
                } else if (result.turtle.status === 'ì£¼ì˜') {
                    result.rounded = { status: 'ê´€ì°° í•„ìš”', text: 'ì–´ê¹¨ ë§ë¦¼ì´ ì‹œì‘ë  ìˆ˜ ìˆìŠµë‹ˆë‹¤.' };
                }
            }
            
            return result;
        }

        function displayResults(data) {
            const getColor = (s) => s === 'ì–‘í˜¸' ? 'bg-green-500' : (s === 'ì£¼ì˜' ? 'bg-yellow-500' : 'bg-red-500');
            const getBadge = (s) => s === 'ì–‘í˜¸' ? 'bg-green-100 text-green-700' : (s === 'ì£¼ì˜' ? 'bg-yellow-100 text-yellow-700' : 'bg-red-100 text-red-700');

            // [FIXED] whitespace-nowrapê³¼ shrink-0 í´ë˜ìŠ¤ ì¶”ê°€
            resultCards.innerHTML = `
                <!-- Rounded Shoulder -->
                <div class="bg-white rounded-2xl p-6 shadow-sm border border-slate-100 overflow-hidden relative">
                    <div class="absolute top-0 left-0 w-2 h-full ${getColor(data.rounded.status)}"></div>
                    <div class="pl-4">
                        <div class="flex justify-between items-start mb-4">
                            <div><h3 class="text-lg font-bold text-slate-800">ë¼ìš´ë“œ ìˆ„ë”</h3></div>
                            <span class="px-3 py-1 rounded-full text-sm font-bold whitespace-nowrap shrink-0 ${getBadge(data.rounded.status)}">${data.rounded.status}</span>
                        </div>
                        <p class="text-slate-700 mb-6 font-medium bg-slate-50 p-3 rounded-lg">${data.rounded.text}</p>
                        ${data.rounded.status !== 'ì–‘í˜¸' ? `
                        <div class="space-y-3">
                            <h4 class="font-bold text-sm text-slate-900 flex items-center gap-2"><i class="ph ph-check-circle text-teal-600"></i> í—¬ìŠ¤ì¥ ì¶”ì²œ ì†”ë£¨ì…˜</h4>
                            <div class="grid grid-cols-1 sm:grid-cols-2 gap-3">
                                <div class="bg-slate-50 p-3 rounded-lg text-sm border border-slate-100"><strong class="block text-slate-800">í˜ì´ìŠ¤ í’€</strong>ì¼€ì´ë¸” ë‹¹ê¸°ê¸°</div>
                                <div class="bg-slate-50 p-3 rounded-lg text-sm border border-slate-100"><strong class="block text-slate-800">ìˆ„ë” í”„ë ˆìŠ¤</strong>ì–´ê¹¨ ê·¼ë ¥ ê°•í™”</div>
                            </div>
                        </div>` : ''}
                    </div>
                </div>

                <!-- Turtle Neck -->
                <div class="bg-white rounded-2xl p-6 shadow-sm border border-slate-100 overflow-hidden relative">
                    <div class="absolute top-0 left-0 w-2 h-full ${getColor(data.turtle.status)}"></div>
                    <div class="pl-4">
                        <div class="flex justify-between items-start mb-4">
                            <div><h3 class="text-lg font-bold text-slate-800">ê±°ë¶ëª©</h3></div>
                            <span class="px-3 py-1 rounded-full text-sm font-bold whitespace-nowrap shrink-0 ${getBadge(data.turtle.status)}">${data.turtle.status}</span>
                        </div>
                        <p class="text-slate-700 mb-6 font-medium bg-slate-50 p-3 rounded-lg">${data.turtle.text}</p>
                        ${data.turtle.status !== 'ì–‘í˜¸' ? `
                        <div class="space-y-3">
                            <h4 class="font-bold text-sm text-slate-900 flex items-center gap-2"><i class="ph ph-check-circle text-teal-600"></i> í—¬ìŠ¤ì¥ ì¶”ì²œ ì†”ë£¨ì…˜</h4>
                            <div class="grid grid-cols-1 sm:grid-cols-2 gap-3">
                                <div class="bg-slate-50 p-3 rounded-lg text-sm border border-slate-100"><strong class="block text-slate-800">ëª© í´ê¸° (Extension)</strong>ê²½ì¶” ì»¤ë¸Œ íšŒë³µ</div>
                                <div class="bg-slate-50 p-3 rounded-lg text-sm border border-slate-100"><strong class="block text-slate-800">ì—… ë¼ì´íŠ¸ ë¡œìš°</strong>ìŠ¹ëª¨ê·¼ ê°•í™”</div>
                            </div>
                        </div>` : ''}
                    </div>
                </div>
            `;
        }

        // 6. ë‹¤ì‹œ í•˜ê¸°
        resetAllBtn.addEventListener('click', () => {
            location.reload(); // ê°€ì¥ ê¹”ë”í•œ ì´ˆê¸°í™”
        });

        // 7. ì´íƒˆ ê°ì§€ ë° ì„¤ë¬¸ì¡°ì‚¬
        function goToSurvey() {
            window.location.href = SURVEY_URL;
        }

        function closeModal() {
            exitModal.classList.add('hidden');
        }

        function initExitIntent() {
            // (1) PC: ë§ˆìš°ìŠ¤ ì´íƒˆ
            document.addEventListener('mouseleave', (e) => {
                if (e.clientY <= 0 && !hasShownExitModal) {
                    showModal();
                }
            });

            // (2) Mobile: ë’¤ë¡œê°€ê¸°
            window.history.pushState({ page: 1 }, "", ""); 
            window.onpopstate = function(event) {
                if (!hasShownExitModal) {
                    window.history.pushState({ page: 1 }, "", ""); // ë‹¤ì‹œ stateë¥¼ ë„£ì–´ ë’¤ë¡œê°€ê¸° ë§‰ìŒ
                    showModal();
                }
            };
        }

        function showModal() {
            hasShownExitModal = true;
            exitModal.classList.remove('hidden');
        }

    </script>
</body>
</html>